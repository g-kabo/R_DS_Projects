<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Me" />


<title>NYC Flights Model</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
      </style>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Personal Website</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="NYC_Flights_EDA.html">NYC Flights EDA</a>
</li>
<li>
  <a href="NYC_Flights_TidyModel.html">NYC Flights with Tidymodels</a>
</li>
<li>
  <a href="OKCupidDataAnalysis.html">OK Cupid</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">NYC Flights Model</h1>
<h4 class="author">Me</h4>
<h4 class="date">14/10/2020</h4>

</div>


<p>This is a continuation of working on the NYC Flight Data for the year 2013. The aim is create a model that can predict whether or not a flight will be 30 minutes late, given a set of parameters.</p>
<pre class="r"><code>library(tidymodels)
library(tidyverse)
library(skimr)
library(nycflights13)
library(timeDate)
library(lubridate)
library(maps)
library(patchwork)
library(corrplot)
library(GGally)
library(rpart.plot)
library(vip)

theme_set(theme_bw())</code></pre>
<div id="splitting-the-data" class="section level1">
<h1><span class="header-section-number">1</span> Splitting the data</h1>
<pre class="r"><code>full_flights=readRDS(&quot;Cleaned_Full_Flights.rds&quot;) </code></pre>
<pre class="r"><code>new_full_flights = 
full_flights %&gt;%
  select(-tailnum,-flight,-time_hour)  #This would&#39;ve been used as ID to investigate the wrong cases</code></pre>
<pre class="r"><code>skim(new_full_flights)</code></pre>
<table>
<caption>Data summary</caption>
<tbody>
<tr class="odd">
<td align="left">Name</td>
<td align="left">new_full_flights</td>
</tr>
<tr class="even">
<td align="left">Number of rows</td>
<td align="left">232412</td>
</tr>
<tr class="odd">
<td align="left">Number of columns</td>
<td align="left">15</td>
</tr>
<tr class="even">
<td align="left">_______________________</td>
<td align="left"></td>
</tr>
<tr class="odd">
<td align="left">Column type frequency:</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">Date</td>
<td align="left">1</td>
</tr>
<tr class="odd">
<td align="left">factor</td>
<td align="left">6</td>
</tr>
<tr class="even">
<td align="left">numeric</td>
<td align="left">8</td>
</tr>
<tr class="odd">
<td align="left">________________________</td>
<td align="left"></td>
</tr>
<tr class="even">
<td align="left">Group variables</td>
<td align="left">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: Date</strong></p>
<table>
<thead>
<tr class="header">
<th align="left">skim_variable</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="left">min</th>
<th align="left">max</th>
<th align="left">median</th>
<th align="right">n_unique</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">dep_date</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="left">2013-01-01</td>
<td align="left">2013-12-30</td>
<td align="left">2013-07-06</td>
<td align="right">364</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: factor</strong></p>
<table>
<thead>
<tr class="header">
<th align="left">skim_variable</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="left">ordered</th>
<th align="right">n_unique</th>
<th align="left">top_counts</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">carrier</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="left">FALSE</td>
<td align="right">16</td>
<td align="left">UA: 46705, B6: 43035, EV: 42735, DL: 39866</td>
</tr>
<tr class="even">
<td align="left">origin</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="left">FALSE</td>
<td align="right">3</td>
<td align="left">EWR: 91968, JFK: 77973, LGA: 62471</td>
</tr>
<tr class="odd">
<td align="left">is_late</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="left">FALSE</td>
<td align="right">2</td>
<td align="left">0: 199198, 1: 33214</td>
</tr>
<tr class="even">
<td align="left">mnfr_year</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="left">FALSE</td>
<td align="right">7</td>
<td align="left">200: 85189, 200: 56473, 199: 38295, 199: 21498</td>
</tr>
<tr class="odd">
<td align="left">engine_type</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="left">FALSE</td>
<td align="right">3</td>
<td align="left">Tur: 197038, Tur: 33878, Oth: 1496</td>
</tr>
<tr class="even">
<td align="left">tzone</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="left">FALSE</td>
<td align="right">6</td>
<td align="left">Ame: 134986, Ame: 47286, Ame: 37241, Ame: 8455</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table>
<thead>
<tr class="header">
<th align="left">skim_variable</th>
<th align="right">n_missing</th>
<th align="right">complete_rate</th>
<th align="right">mean</th>
<th align="right">sd</th>
<th align="right">p0</th>
<th align="right">p25</th>
<th align="right">p50</th>
<th align="right">p75</th>
<th align="right">p100</th>
<th align="left">hist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">dep_delay</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">11.62</td>
<td align="right">37.99</td>
<td align="right">-43.00</td>
<td align="right">-5.00</td>
<td align="right">-2.00</td>
<td align="right">10.00</td>
<td align="right">1301.00</td>
<td align="left">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td align="left">temp</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">56.99</td>
<td align="right">18.06</td>
<td align="right">10.94</td>
<td align="right">42.08</td>
<td align="right">57.02</td>
<td align="right">71.96</td>
<td align="right">100.04</td>
<td align="left">▁▇▇▇▂</td>
</tr>
<tr class="odd">
<td align="left">precip</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">0.00</td>
<td align="right">0.01</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
<td align="right">0.00</td>
<td align="right">0.53</td>
<td align="left">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td align="left">visib</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">9.58</td>
<td align="right">1.46</td>
<td align="right">0.00</td>
<td align="right">10.00</td>
<td align="right">10.00</td>
<td align="right">10.00</td>
<td align="right">10.00</td>
<td align="left">▁▁▁▁▇</td>
</tr>
<tr class="odd">
<td align="left">seats</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">136.82</td>
<td align="right">71.96</td>
<td align="right">2.00</td>
<td align="right">55.00</td>
<td align="right">149.00</td>
<td align="right">189.00</td>
<td align="right">400.00</td>
<td align="left">▆▅▇▁▁</td>
</tr>
<tr class="even">
<td align="left">lat</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">36.02</td>
<td align="right">5.76</td>
<td align="right">21.32</td>
<td align="right">32.73</td>
<td align="right">36.10</td>
<td align="right">41.41</td>
<td align="right">61.17</td>
<td align="left">▃▆▇▁▁</td>
</tr>
<tr class="odd">
<td align="left">lon</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">-90.15</td>
<td align="right">15.70</td>
<td align="right">-157.92</td>
<td align="right">-95.34</td>
<td align="right">-84.22</td>
<td align="right">-80.15</td>
<td align="right">-68.83</td>
<td align="left">▁▁▂▃▇</td>
</tr>
<tr class="even">
<td align="left">alt</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">590.66</td>
<td align="right">995.14</td>
<td align="right">3.00</td>
<td align="right">26.00</td>
<td align="right">313.00</td>
<td align="right">748.00</td>
<td align="right">6602.00</td>
<td align="left">▇▁▁▁▁</td>
</tr>
</tbody>
</table>
<pre class="r"><code>set.seed(4321)
flights_split = initial_split(new_full_flights, prop = 0.7, strata = is_late)

flights_train = training(flights_split)
flights_test = testing(flights_split)</code></pre>
</div>
<div id="create-a-recipe" class="section level1">
<h1><span class="header-section-number">2</span> Create a recipe</h1>
<pre class="r"><code>flights_rec =
  recipe(is_late ~ .,data=flights_train ) %&gt;%
  #step_knnimpute(all_predictors()) %&gt;%
  #update_role(flight, tailnum, time_hour, new_role=&quot;ID&quot;)%&gt;%
  step_date(dep_date, features = c(&quot;dow&quot;, &quot;month&quot;)) %&gt;% 
  step_holiday( dep_date, holidays = timeDate::listHolidays() %&gt;% str_subset(&quot;(^US)|(Easter)&quot;) ) %&gt;%
  step_rm(dep_date) %&gt;% 
  step_dummy(all_nominal(),-all_outcomes()) %&gt;%
  step_zv(all_predictors())


tree_rec = 
  recipe(is_late ~.,data=flights_train) %&gt;%
  #update_role(flight, tailnum, time_hour, new_role =&quot;ID&quot;) %&gt;%
  step_zv(all_predictors())</code></pre>
</div>
<div id="fit-a-model-with-a-recipe" class="section level1">
<h1><span class="header-section-number">3</span> Fit a model with a recipe</h1>
<pre class="r"><code>logist_mod = logistic_reg() %&gt;%
  set_engine(&quot;glm&quot;)

tree_mod = decision_tree(cost_complexity = tune(), 
                         tree_depth = tune()
                         ) %&gt;%
  set_engine(&quot;rpart&quot;) %&gt;% 
  set_mode(&quot;classification&quot;)</code></pre>
<div id="tree-grid-search" class="section level2">
<h2><span class="header-section-number">3.1</span> Tree Grid Search</h2>
<pre class="r"><code>set.seed(512)
tree_params = grid_max_entropy(cost_complexity(),tree_depth(range = c(3,5)),size=9)</code></pre>
<pre class="r"><code>set.seed(512)
grid_max_entropy(cost_complexity(),tree_depth(range = c(3,5)),size=9) %&gt;%
  ggplot(aes(tree_depth,log(cost_complexity)))+
  geom_point()+
  theme_bw()</code></pre>
<p><img src="NYC_Flights_TidyModel_files/figure-html/unnamed-chunk-9-1.png" width="672" /></p>
<p>Now we tune using resamples</p>
<pre class="r"><code>doParallel::registerDoParallel()

Start = Sys.time()

set.seed(234)

flights_folds = vfold_cv(flights_train, v=5, strata = is_late) 


set.seed(345)

tree_wf = workflow() %&gt;%
  add_model(tree_mod) %&gt;%
  add_recipe(tree_rec)


tree_res = tree_wf %&gt;% 
  tune_grid( resamples = flights_folds,
             grid=tree_params)
End = Sys.time()

doParallel::stopImplicitCluster()

paste(&quot;Time Taken:&quot;,End-Start)</code></pre>
<pre><code>## [1] &quot;Time Taken: 1.09096333185832&quot;</code></pre>
<pre class="r"><code>tree_res %&gt;%
  collect_metrics() %&gt;%
  mutate(tree_depth = factor(tree_depth)) %&gt;%
  ggplot(aes(x=cost_complexity,y=mean,color=tree_depth))+
  geom_line(size=1.5,alpha=0.6)+
  geom_point(size=2)+
  facet_wrap(~.metric, scales=&quot;free&quot;,nrow=2)+
  scale_x_log10(labels=label_number())+
  scale_color_viridis_d(option=&quot;C&quot;,begin=.9,end=0)+
  theme_bw()</code></pre>
<p><img src="NYC_Flights_TidyModel_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
</div>
<div id="select-best-tree" class="section level2">
<h2><span class="header-section-number">3.2</span> Select Best Tree</h2>
<pre class="r"><code>best_tree = tree_res %&gt;%
  select_best(&quot;roc_auc&quot;)</code></pre>
</div>
<div id="logistic-model" class="section level2">
<h2><span class="header-section-number">3.3</span> Logistic Model</h2>
<p>Now we fit the logistic model</p>
<pre class="r"><code>logt_wf = workflow() %&gt;%
  add_model(logist_mod) %&gt;%
  add_recipe(flights_rec)

logt_wf</code></pre>
<pre><code>## == Workflow ================================================================================================================================================================
## Preprocessor: Recipe
## Model: logistic_reg()
## 
## -- Preprocessor ------------------------------------------------------------------------------------------------------------------------------------------------------------
## 5 Recipe Steps
## 
## * step_date()
## * step_holiday()
## * step_rm()
## * step_dummy()
## * step_zv()
## 
## -- Model -------------------------------------------------------------------------------------------------------------------------------------------------------------------
## Logistic Regression Model Specification (classification)
## 
## Computational engine: glm</code></pre>
<pre class="r"><code>logt_fit = fit(logt_wf, data = flights_train)</code></pre>
<pre><code>## Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred</code></pre>
<pre class="r"><code>expo_coefs  = logt_fit %&gt;%
  pull_workflow_fit() %&gt;%
  tidy()

test_expo_coefs = 
  logt_fit %&gt;%
  pull_workflow_fit()%&gt;%
  tidy(exponentiate=TRUE) %&gt;% 
  mutate(conf_low = estimate - 1.96*std.error,
         conf_high = estimate + 1.96*std.error,
         #Significant =   if_else(p.value &lt; 0.05 ,&quot;True&quot;,&quot;False&quot;)
         )
   # tidy(conf.int=TRUE) 

expo_coefs %&gt;%
  rmarkdown::paged_table()</code></pre>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["term"],"name":[1],"type":["chr"],"align":["left"]},{"label":["estimate"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["std.error"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["statistic"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["p.value"],"name":[5],"type":["dbl"],"align":["right"]}],"data":[{"1":"(Intercept)","2":"-2.634234e+00","3":"4.576723e-01","4":"-5.7557194","5":"8.627357e-09"},{"1":"dep_delay","2":"1.025907e-01","3":"6.558057e-04","4":"156.4345731","5":"0.000000e+00"},{"1":"temp","2":"2.758358e-03","3":"1.507086e-03","4":"1.8302588","5":"6.721126e-02"},{"1":"precip","2":"6.987677e-01","3":"7.443730e-01","4":"0.9387333","5":"3.478677e-01"},{"1":"visib","2":"-1.427853e-01","3":"7.562611e-03","4":"-18.8804202","5":"1.652662e-79"},{"1":"seats","2":"-3.933376e-04","3":"2.760915e-04","4":"-1.4246641","5":"1.542543e-01"},{"1":"lat","2":"-1.449224e-02","3":"2.964368e-03","4":"-4.8888134","5":"1.014456e-06"},{"1":"lon","2":"-7.451851e-03","3":"4.059072e-03","4":"-1.8358509","5":"6.637972e-02"},{"1":"alt","2":"3.063926e-05","3":"3.225651e-05","4":"0.9498628","5":"3.421819e-01"},{"1":"dep_date_Easter","2":"5.047542e-02","3":"3.224700e-01","4":"0.1565275","5":"8.756172e-01"},{"1":"dep_date_EasterMonday","2":"-2.004689e-01","3":"2.042364e-01","4":"-0.9815535","5":"3.263199e-01"},{"1":"dep_date_EasterSunday","2":"NA","3":"NA","4":"NA","5":"NA"},{"1":"dep_date_USChristmasDay","2":"-1.119117e+00","3":"3.517410e-01","4":"-3.1816512","5":"1.464381e-03"},{"1":"dep_date_USColumbusDay","2":"-9.492795e-01","3":"3.041498e-01","4":"-3.1210922","5":"1.801816e-03"},{"1":"dep_date_USCPulaskisBirthday","2":"-3.418685e-01","3":"2.717302e-01","4":"-1.2581171","5":"2.083494e-01"},{"1":"dep_date_USDecorationMemorialDay","2":"2.314393e-01","3":"2.123123e-01","4":"1.0900889","5":"2.756740e-01"},{"1":"dep_date_USElectionDay","2":"3.936087e-02","3":"3.125216e-01","4":"0.1259461","5":"8.997746e-01"},{"1":"dep_date_USGoodFriday","2":"-1.201825e+00","3":"3.381669e-01","4":"-3.5539395","5":"3.795065e-04"},{"1":"dep_date_USInaugurationDay","2":"4.477577e-02","3":"2.760238e-01","4":"0.1622171","5":"8.711349e-01"},{"1":"dep_date_USIndependenceDay","2":"-1.359172e+00","3":"3.350579e-01","4":"-4.0565276","5":"4.980768e-05"},{"1":"dep_date_USLaborDay","2":"7.195632e-02","3":"3.671994e-01","4":"0.1959598","5":"8.446416e-01"},{"1":"dep_date_USLincolnsBirthday","2":"-4.168065e-01","3":"2.959017e-01","4":"-1.4085978","5":"1.589541e-01"},{"1":"dep_date_USMemorialDay","2":"-3.639084e-01","3":"3.375428e-01","4":"-1.0781102","5":"2.809846e-01"},{"1":"dep_date_USMLKingsBirthday","2":"2.333096e-01","3":"2.405635e-01","4":"0.9698463","5":"3.321231e-01"},{"1":"dep_date_USNewYearsDay","2":"7.188448e-01","3":"2.398255e-01","4":"2.9973655","5":"2.723240e-03"},{"1":"dep_date_USPresidentsDay","2":"-5.665937e-01","3":"2.355460e-01","4":"-2.4054486","5":"1.615263e-02"},{"1":"dep_date_USThanksgivingDay","2":"-2.817913e-01","3":"2.524013e-01","4":"-1.1164415","5":"2.642332e-01"},{"1":"dep_date_USVeteransDay","2":"2.050912e-01","3":"2.230724e-01","4":"0.9193929","5":"3.578901e-01"},{"1":"dep_date_USWashingtonsBirthday","2":"3.453606e-01","3":"2.038692e-01","4":"1.6940301","5":"9.025956e-02"},{"1":"carrier_AA","2":"-1.663710e-01","3":"1.235963e-01","4":"-1.3460845","5":"1.782753e-01"},{"1":"carrier_AS","2":"-2.916780e-01","3":"3.451489e-01","4":"-0.8450787","5":"3.980669e-01"},{"1":"carrier_B6","2":"4.480035e-01","3":"6.263052e-02","4":"7.1531183","5":"8.482841e-13"},{"1":"carrier_DL","2":"-2.872068e-02","3":"7.419662e-02","4":"-0.3870888","5":"6.986905e-01"},{"1":"carrier_EV","2":"2.932532e-01","3":"7.274313e-02","4":"4.0313527","5":"5.545674e-05"},{"1":"carrier_F9","2":"7.807118e-01","3":"2.290868e-01","4":"3.4079300","5":"6.545767e-04"},{"1":"carrier_FL","2":"6.014470e-01","3":"1.233616e-01","4":"4.8754779","5":"1.085453e-06"},{"1":"carrier_HA","2":"1.900400e-01","3":"7.084506e-01","4":"0.2682473","5":"7.885089e-01"},{"1":"carrier_MQ","2":"-9.244144e-02","3":"3.324488e-01","4":"-0.2780622","5":"7.809646e-01"},{"1":"carrier_OO","2":"1.337833e+00","3":"1.233725e+00","4":"1.0843845","5":"2.781944e-01"},{"1":"carrier_UA","2":"-1.478661e-01","3":"8.257771e-02","4":"-1.7906301","5":"7.335267e-02"},{"1":"carrier_US","2":"5.504532e-01","3":"8.455092e-02","4":"6.5103156","5":"7.499310e-11"},{"1":"carrier_VX","2":"-2.231111e-01","3":"1.277996e-01","4":"-1.7457882","5":"8.084777e-02"},{"1":"carrier_WN","2":"-3.093824e-01","3":"9.156380e-02","4":"-3.3788730","5":"7.278362e-04"},{"1":"carrier_YV","2":"7.186181e-01","3":"2.631004e-01","4":"2.7313461","5":"6.307619e-03"},{"1":"origin_JFK","2":"-5.176306e-02","3":"4.679001e-02","4":"-1.1062845","5":"2.686034e-01"},{"1":"origin_LGA","2":"1.182699e-01","3":"4.069935e-02","4":"2.9059398","5":"3.661519e-03"},{"1":"mnfr_year_X1990","2":"-1.039866e-01","3":"8.653173e-02","4":"-1.2017166","5":"2.294733e-01"},{"1":"mnfr_year_X1995","2":"-1.744502e-01","3":"8.708505e-02","4":"-2.0032158","5":"4.515413e-02"},{"1":"mnfr_year_X2000","2":"-2.037235e-01","3":"8.544306e-02","4":"-2.3843188","5":"1.711077e-02"},{"1":"mnfr_year_X2005","2":"-2.409444e-01","3":"9.073022e-02","4":"-2.6556129","5":"7.916443e-03"},{"1":"mnfr_year_X2010","2":"-2.661307e-01","3":"9.846202e-02","4":"-2.7028768","5":"6.874223e-03"},{"1":"mnfr_year_Other","2":"3.342841e-01","3":"2.780928e-01","4":"1.2020595","5":"2.293405e-01"},{"1":"engine_type_Turbo.jet","2":"1.192142e-01","3":"4.502091e-02","4":"2.6479747","5":"8.097559e-03"},{"1":"engine_type_Other","2":"-1.649458e-01","3":"1.920303e-01","4":"-0.8589575","5":"3.903640e-01"},{"1":"tzone_America.Denver","2":"-2.043001e-01","3":"1.658144e-01","4":"-1.2321015","5":"2.179112e-01"},{"1":"tzone_America.Los_Angeles","2":"-1.289802e-01","3":"1.237265e-01","4":"-1.0424624","5":"2.971974e-01"},{"1":"tzone_America.New_York","2":"-8.617911e-02","3":"6.268985e-02","4":"-1.3746900","5":"1.692276e-01"},{"1":"tzone_America.Phoenix","2":"-5.118502e-01","3":"1.346408e-01","4":"-3.8015990","5":"1.437652e-04"},{"1":"tzone_Other","2":"-1.087886e+00","3":"4.461244e-01","4":"-2.4385261","5":"1.474729e-02"},{"1":"dep_date_dow_Mon","2":"1.080072e-01","3":"4.905875e-02","4":"2.2015895","5":"2.769432e-02"},{"1":"dep_date_dow_Tue","2":"-4.530058e-02","3":"4.929254e-02","4":"-0.9190148","5":"3.580878e-01"},{"1":"dep_date_dow_Wed","2":"9.362680e-02","3":"4.833175e-02","4":"1.9371697","5":"5.272461e-02"},{"1":"dep_date_dow_Thu","2":"2.611565e-01","3":"4.720685e-02","4":"5.5321736","5":"3.162867e-08"},{"1":"dep_date_dow_Fri","2":"9.679170e-02","3":"4.708562e-02","4":"2.0556530","5":"3.981597e-02"},{"1":"dep_date_dow_Sat","2":"-3.733204e-01","3":"5.220258e-02","4":"-7.1513785","5":"8.591072e-13"},{"1":"dep_date_month_Feb","2":"-2.283419e-02","3":"6.850689e-02","4":"-0.3333123","5":"7.388986e-01"},{"1":"dep_date_month_Mar","2":"-1.982368e-01","3":"6.656056e-02","4":"-2.9782930","5":"2.898587e-03"},{"1":"dep_date_month_Apr","2":"5.008371e-01","3":"6.759698e-02","4":"7.4091638","5":"1.270982e-13"},{"1":"dep_date_month_May","2":"-4.126859e-01","3":"7.897737e-02","4":"-5.2253693","5":"1.738079e-07"},{"1":"dep_date_month_Jun","2":"2.351881e-01","3":"8.580264e-02","4":"2.7410363","5":"6.124575e-03"},{"1":"dep_date_month_Jul","2":"3.053784e-01","3":"9.353703e-02","4":"3.2647865","5":"1.095466e-03"},{"1":"dep_date_month_Aug","2":"-4.870349e-02","3":"8.833926e-02","4":"-0.5513233","5":"5.814121e-01"},{"1":"dep_date_month_Sep","2":"-6.027914e-01","3":"9.023786e-02","4":"-6.6800281","5":"2.388965e-11"},{"1":"dep_date_month_Oct","2":"-3.434796e-01","3":"7.918509e-02","4":"-4.3376799","5":"1.439946e-05"},{"1":"dep_date_month_Nov","2":"-1.619635e-01","3":"7.227245e-02","4":"-2.2410133","5":"2.502522e-02"},{"1":"dep_date_month_Dec","2":"2.224101e-01","3":"6.168546e-02","4":"3.6055510","5":"3.114913e-04"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<p>We can also observe the odds ratio which tells us the relative risk of a fligtht being late when associated with either a unit change or factor change.</p>
<pre class="r"><code>test_expo_coefs %&gt;%
  select(term,estimate) %&gt;%
  rename(Odds_Ratio = estimate)%&gt;%
  rmarkdown::paged_table()</code></pre>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["term"],"name":[1],"type":["chr"],"align":["left"]},{"label":["Odds_Ratio"],"name":[2],"type":["dbl"],"align":["right"]}],"data":[{"1":"(Intercept)","2":"0.07177396"},{"1":"dep_delay","2":"1.10803778"},{"1":"temp","2":"1.00276217"},{"1":"precip","2":"2.01127268"},{"1":"visib","2":"0.86694020"},{"1":"seats","2":"0.99960674"},{"1":"lat","2":"0.98561226"},{"1":"lon","2":"0.99257584"},{"1":"alt","2":"1.00003064"},{"1":"dep_date_Easter","2":"1.05177101"},{"1":"dep_date_EasterMonday","2":"0.81834693"},{"1":"dep_date_EasterSunday","2":"NA"},{"1":"dep_date_USChristmasDay","2":"0.32656793"},{"1":"dep_date_USColumbusDay","2":"0.38701977"},{"1":"dep_date_USCPulaskisBirthday","2":"0.71044166"},{"1":"dep_date_USDecorationMemorialDay","2":"1.26041277"},{"1":"dep_date_USElectionDay","2":"1.04014577"},{"1":"dep_date_USGoodFriday","2":"0.30064510"},{"1":"dep_date_USInaugurationDay","2":"1.04579334"},{"1":"dep_date_USIndependenceDay","2":"0.25687347"},{"1":"dep_date_USLaborDay","2":"1.07460841"},{"1":"dep_date_USLincolnsBirthday","2":"0.65914846"},{"1":"dep_date_USMemorialDay","2":"0.69495488"},{"1":"dep_date_USMLKingsBirthday","2":"1.26277233"},{"1":"dep_date_USNewYearsDay","2":"2.05206123"},{"1":"dep_date_USPresidentsDay","2":"0.56745507"},{"1":"dep_date_USThanksgivingDay","2":"0.75443110"},{"1":"dep_date_USVeteransDay","2":"1.22763702"},{"1":"dep_date_USWashingtonsBirthday","2":"1.41249912"},{"1":"carrier_AA","2":"0.84673202"},{"1":"carrier_AS","2":"0.74700901"},{"1":"carrier_B6","2":"1.56518420"},{"1":"carrier_DL","2":"0.97168784"},{"1":"carrier_EV","2":"1.34078225"},{"1":"carrier_F9","2":"2.18302563"},{"1":"carrier_FL","2":"1.82475725"},{"1":"carrier_HA","2":"1.20929795"},{"1":"carrier_MQ","2":"0.91170260"},{"1":"carrier_OO","2":"3.81077531"},{"1":"carrier_UA","2":"0.86254658"},{"1":"carrier_US","2":"1.73403870"},{"1":"carrier_VX","2":"0.80002598"},{"1":"carrier_WN","2":"0.73390004"},{"1":"carrier_YV","2":"2.05159619"},{"1":"origin_JFK","2":"0.94955383"},{"1":"origin_LGA","2":"1.12554781"},{"1":"mnfr_year_X1990","2":"0.90123736"},{"1":"mnfr_year_X1995","2":"0.83991872"},{"1":"mnfr_year_X2000","2":"0.81568788"},{"1":"mnfr_year_X2005","2":"0.78588536"},{"1":"mnfr_year_X2010","2":"0.76633896"},{"1":"mnfr_year_Other","2":"1.39693990"},{"1":"engine_type_Turbo.jet","2":"1.12661125"},{"1":"engine_type_Other","2":"0.84793964"},{"1":"tzone_America.Denver","2":"0.81521767"},{"1":"tzone_America.Los_Angeles","2":"0.87899138"},{"1":"tzone_America.New_York","2":"0.91742989"},{"1":"tzone_America.Phoenix","2":"0.59938558"},{"1":"tzone_Other","2":"0.33692799"},{"1":"dep_date_dow_Mon","2":"1.11405579"},{"1":"dep_date_dow_Tue","2":"0.95571017"},{"1":"dep_date_dow_Wed","2":"1.09814984"},{"1":"dep_date_dow_Thu","2":"1.29843084"},{"1":"dep_date_dow_Fri","2":"1.10163088"},{"1":"dep_date_dow_Sat","2":"0.68844460"},{"1":"dep_date_month_Feb","2":"0.97742454"},{"1":"dep_date_month_Mar","2":"0.82017558"},{"1":"dep_date_month_Apr","2":"1.65010197"},{"1":"dep_date_month_May","2":"0.66187014"},{"1":"dep_date_month_Jun","2":"1.26514677"},{"1":"dep_date_month_Jul","2":"1.35713848"},{"1":"dep_date_month_Aug","2":"0.95246350"},{"1":"dep_date_month_Sep","2":"0.54728180"},{"1":"dep_date_month_Oct","2":"0.70929798"},{"1":"dep_date_month_Nov","2":"0.85047224"},{"1":"dep_date_month_Dec","2":"1.24908349"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<p>We can interpret this as a unit change in <code>dep_delay</code> is associated with a 10.8% increase in the odds of a flight being late. With factor variables, it is related to the change from the base level. If a factor is not significant, then it suggests that there is not enough evidence to say the two factors change the odds of a flight being late.</p>
<pre class="r"><code>expo_coefs %&gt;%
  filter( !str_starts(term,&quot;dep|carrier|engine|tzone|origin|mnfr_year&quot;)) %&gt;%
  filter( !term == &quot;(Intercept)&quot;) %&gt;%
  mutate( Significant =   if_else(p.value &lt; 0.05 ,&quot;True&quot;,&quot;False&quot;))%&gt;%
  ggplot(aes(y=term,x=estimate,col=Significant))+
  geom_point()+
    geom_vline(xintercept = 0,col=&quot;grey80&quot;,lty=2,size=2)+
  geom_errorbar(aes(xmin=estimate-1.96*std.error,
                    xmax=estimate+1.96*std.error),width=0.5)+
  labs(title=&quot;Log Odds Ratio&quot;,col=&quot;Significant at\n5% level&quot;)+
  theme_bw()</code></pre>
<p><img src="NYC_Flights_TidyModel_files/figure-html/unnamed-chunk-17-1.png" width="672" /></p>
<pre class="r"><code>expo_coefs %&gt;%
  filter( str_starts(term,&quot;carrier&quot;)) %&gt;%
  mutate( Significant =   if_else(p.value &lt; 0.05 ,&quot;True&quot;,&quot;False&quot;))%&gt;%
  ggplot(aes(y=term,x=estimate,col=Significant))+
  geom_vline(xintercept = 0,col=&quot;grey80&quot;,lty=2,size=2)+
  geom_point()+
  geom_errorbar(aes(xmin=estimate-1.96*std.error,
                    xmax=estimate+1.96*std.error),width=0.5)+
    labs(title=&quot;Log Odds of Carrier&quot;)+
  theme_bw()</code></pre>
<p><img src="NYC_Flights_TidyModel_files/figure-html/unnamed-chunk-18-1.png" width="672" /></p>
<pre class="r"><code>test_expo_coefs %&gt;%
  filter( str_starts(term,&quot;carrier&quot;)) %&gt;%
  mutate( Significant =   if_else(p.value &lt; 0.05 ,&quot;True&quot;,&quot;False&quot;))%&gt;%
  ggplot(aes(y=term,x=estimate,col=Significant))+
    geom_vline(xintercept = 1 ,col=&quot;grey80&quot;,lty=2,size=2)+
  geom_point()+
    geom_errorbar(aes(xmin=conf_low,
                    xmax=conf_high),width=0.5)+
    labs(title=&quot;Log Odds Ratio of Carrier&quot;)+
   theme_bw()</code></pre>
<p><img src="NYC_Flights_TidyModel_files/figure-html/unnamed-chunk-19-1.png" width="672" /></p>
<pre class="r"><code>expo_coefs %&gt;%
  filter( str_starts(term,&quot;dep_date_month&quot;)) %&gt;%
  mutate( Significant =   if_else(p.value &lt; 0.05 ,&quot;True&quot;,&quot;False&quot;))%&gt;%
  mutate( term =  str_replace(term,&quot;dep_date_month_&quot;,&quot;&quot;)) %&gt;%
  mutate( term = factor(term, 
                        levels=c(&quot;Feb&quot;,&quot;Mar&quot;,&quot;Apr&quot;,&quot;May&quot;,&quot;Jun&quot;,
                                 &quot;Jul&quot;,&quot;Aug&quot;,&quot;Sep&quot;,&quot;Oct&quot;,&quot;Nov&quot;,&quot;Dec&quot;))) %&gt;%
  ggplot(aes(y=term,x=estimate,col=Significant))+
    geom_vline(xintercept = 0,col=&quot;grey80&quot;,lty=2,size=2)+
  geom_point()+
  geom_errorbar(aes(xmin=estimate-1.96*std.error,
                    xmax=estimate+1.96*std.error),width=0.5)+
  coord_flip()+
  labs(title=&quot;Log Odds Ratio by Month&quot;)+
   theme_bw()</code></pre>
<p><img src="NYC_Flights_TidyModel_files/figure-html/unnamed-chunk-20-1.png" width="672" /></p>
<pre class="r"><code>test_expo_coefs %&gt;%
  filter( str_starts(term,&quot;dep_date_month&quot;)) %&gt;%
  mutate( Significant =   if_else(p.value &lt; 0.05 ,&quot;True&quot;,&quot;False&quot;))%&gt;%
  mutate( term =  str_replace(term,&quot;dep_date_month_&quot;,&quot;&quot;)) %&gt;%
  mutate( term = factor(term, 
                        levels=c(&quot;Feb&quot;,&quot;Mar&quot;,&quot;Apr&quot;,&quot;May&quot;,&quot;Jun&quot;,
                                 &quot;Jul&quot;,&quot;Aug&quot;,&quot;Sep&quot;,&quot;Oct&quot;,&quot;Nov&quot;,&quot;Dec&quot;))) %&gt;%
  ggplot(aes(y=term,x=estimate,col=Significant))+
    geom_vline(xintercept = 1,col=&quot;grey80&quot;,lty=2,size=2)+
  geom_point()+
  geom_errorbar(aes(xmin=exp(log(estimate)-1.96*(std.error)),
                    xmax=exp(log(estimate)+1.96*(std.error))),width=0.5)+
  coord_flip()+
  labs(title=&quot;Odds Ratio by Month&quot;)+
   theme_bw()</code></pre>
<p><img src="NYC_Flights_TidyModel_files/figure-html/unnamed-chunk-21-1.png" width="672" /></p>
<pre class="r"><code>expo_coefs %&gt;%
  filter( str_starts(term,&quot;dep_date_dow&quot;)) %&gt;%
  mutate( Significant =   if_else(p.value &lt; 0.05 ,&quot;True&quot;,&quot;False&quot;))%&gt;%
  mutate( term =  str_replace(term,&quot;dep_date_dow_&quot;,&quot;&quot;)) %&gt;%
  mutate( term = factor(term, 
                        levels=c(&quot;Mon&quot;,&quot;Tue&quot;,&quot;Wed&quot;,&quot;Thu&quot;,&quot;Fri&quot;,&quot;Sat&quot;))) %&gt;%
  ggplot(aes(y=term,x=estimate,col=Significant))+
    geom_vline(xintercept = 0,col=&quot;grey80&quot;,lty=2,size=2)+
  geom_point()+
  geom_errorbar(aes(xmin=estimate-1.96*std.error,
                    xmax=estimate+1.96*std.error),width=0.5)+
  coord_flip()+
  labs(title=&quot;Log Odds Ratio by Day of Week&quot;)+
   theme_bw()</code></pre>
<p><img src="NYC_Flights_TidyModel_files/figure-html/unnamed-chunk-22-1.png" width="672" /></p>
<pre class="r"><code>expo_coefs %&gt;%
  filter( str_starts(term,&quot;mnfr_year&quot;)) %&gt;%
  mutate( Significant =   if_else(p.value &lt; 0.05 ,&quot;True&quot;,&quot;False&quot;))%&gt;%
    mutate( term =  str_replace(term,&quot;mnfr_year_&quot;,&quot;&quot;)) %&gt;%
  ggplot(aes(y=term,x=estimate,col=Significant))+
  geom_vline(xintercept = 0,col=&quot;grey80&quot;,lty=2,size=2)+
  geom_point()+
  geom_errorbar(aes(xmin=estimate-1.96*std.error,
                    xmax=estimate+1.96*std.error),width=0.5)+
  labs(title=&quot;Log Odds Ratio by Engine Manufacturing Year&quot;)+
   theme_bw()</code></pre>
<p><img src="NYC_Flights_TidyModel_files/figure-html/unnamed-chunk-23-1.png" width="672" /></p>
<pre class="r"><code>expo_coefs %&gt;%
  filter( str_starts(term,&quot;engine_type&quot;)) %&gt;%
  mutate( Significant =   if_else(p.value &lt; 0.05 ,&quot;True&quot;,&quot;False&quot;))%&gt;%
    mutate( term =  str_replace(term,&quot;engine_type_&quot;,&quot;&quot;)) %&gt;%
  ggplot(aes(y=term,x=estimate,col=Significant))+
  geom_vline(xintercept = 0,col=&quot;grey80&quot;,lty=2,size=2)+
  geom_point()+
  geom_errorbar(aes(xmin=estimate-1.96*std.error,
                    xmax=estimate+1.96*std.error),width=0.5)+
  labs(title=&quot;Log Odds Ratio of Engine Type&quot;)+
   theme_bw()</code></pre>
<p><img src="NYC_Flights_TidyModel_files/figure-html/unnamed-chunk-24-1.png" width="672" /></p>
<pre class="r"><code>expo_coefs %&gt;%
  filter( str_starts(term,&quot;tzone&quot;)) %&gt;%
  mutate( Significant =   if_else(p.value &lt; 0.05 ,&quot;True&quot;,&quot;False&quot;))%&gt;%
    mutate( term =  str_replace(term,&quot;engine_type_&quot;,&quot;&quot;)) %&gt;%
  ggplot(aes(y=term,x=estimate,col=Significant))+
  geom_vline(xintercept = 0,col=&quot;grey80&quot;,lty=2,size=2)+
  geom_point()+
  geom_errorbar(aes(xmin=estimate-1.96*std.error,
                    xmax=estimate+1.96*std.error),width=0.5)+
  labs(title=&quot;Log Odds Ratio of Timezones&quot;)+
   theme_bw()</code></pre>
<p><img src="NYC_Flights_TidyModel_files/figure-html/unnamed-chunk-25-1.png" width="672" /></p>
<pre class="r"><code>expo_coefs %&gt;%
  filter( str_starts(term,&quot;dep_date_US|dep_date_Eas&quot;)) %&gt;%
  mutate( Significant =   if_else(p.value &lt; 0.05 ,&quot;True&quot;,&quot;False&quot;))%&gt;%
    mutate( term =  str_replace(term,&quot;dep_date_&quot;,&quot;&quot;)) %&gt;%
    ggplot(aes(y=term,x=exp(estimate),col=Significant))+
  geom_vline(xintercept = 1,col=&quot;grey80&quot;,lty=2,size=2)+
  geom_point()+
  geom_errorbar(aes(xmin=exp(estimate-1.96*std.error),
                    xmax=exp(estimate+1.96*std.error)),width=0.5)+
  labs(title=&quot;Odds Ratio of Holiday&quot;)+
   theme_bw()</code></pre>
<pre><code>## Warning: Removed 1 rows containing missing values (geom_point).</code></pre>
<p><img src="NYC_Flights_TidyModel_files/figure-html/unnamed-chunk-26-1.png" width="672" /></p>
</div>
</div>
<div id="finialize-model" class="section level1">
<h1><span class="header-section-number">4</span> Finialize Model</h1>
<pre class="r"><code>final_tree_wf = 
  tree_wf %&gt;%
  finalize_workflow(best_tree)

final_tree_wf</code></pre>
<pre><code>## == Workflow ================================================================================================================================================================
## Preprocessor: Recipe
## Model: decision_tree()
## 
## -- Preprocessor ------------------------------------------------------------------------------------------------------------------------------------------------------------
## 1 Recipe Step
## 
## * step_zv()
## 
## -- Model -------------------------------------------------------------------------------------------------------------------------------------------------------------------
## Decision Tree Model Specification (classification)
## 
## Main Arguments:
##   cost_complexity = 4.61113817239148e-07
##   tree_depth = 5
## 
## Computational engine: rpart</code></pre>
<div id="fit-best-tree" class="section level2">
<h2><span class="header-section-number">4.1</span> Fit Best Tree</h2>
<pre class="r"><code>final_tree = final_tree_wf %&gt;% fit(data=flights_train)

final_tree</code></pre>
<pre><code>## == Workflow [trained] ======================================================================================================================================================
## Preprocessor: Recipe
## Model: decision_tree()
## 
## -- Preprocessor ------------------------------------------------------------------------------------------------------------------------------------------------------------
## 1 Recipe Step
## 
## * step_zv()
## 
## -- Model -------------------------------------------------------------------------------------------------------------------------------------------------------------------
## n= 162689 
## 
## node), split, n, loss, yval, (yprob)
##       * denotes terminal node
## 
##  1) root 162689 23250 0 (0.85708929 0.14291071)  
##    2) dep_delay&lt; 36.5 143273  6128 0 (0.95722851 0.04277149)  
##      4) dep_delay&lt; 18.5 131910  3266 0 (0.97524069 0.02475931) *
##      5) dep_delay&gt;=18.5 11363  2862 0 (0.74812990 0.25187010)  
##       10) dep_delay&lt; 25.5 5392   931 0 (0.82733680 0.17266320)  
##         20) visib&gt;=7.5 4988   805 0 (0.83861267 0.16138733) *
##         21) visib&lt; 7.5 404   126 0 (0.68811881 0.31188119)  
##           42) temp&gt;=33.53 364   102 0 (0.71978022 0.28021978) *
##           43) temp&lt; 33.53 40    16 1 (0.40000000 0.60000000) *
##       11) dep_delay&gt;=25.5 5971  1931 0 (0.67660358 0.32339642)  
##         22) dep_delay&lt; 32.5 4078  1172 0 (0.71260422 0.28739578) *
##         23) dep_delay&gt;=32.5 1893   759 0 (0.59904913 0.40095087)  
##           46) carrier=9E,AA,AS,DL,EV,FL,MQ,UA,VX,WN,YV 1401   509 0 (0.63668808 0.36331192) *
##           47) carrier=B6,F9,US 492   242 1 (0.49186992 0.50813008) *
##    3) dep_delay&gt;=36.5 19416  2294 1 (0.11814998 0.88185002)  
##      6) dep_delay&lt; 48.5 4361  1733 1 (0.39738592 0.60261408)  
##       12) carrier=9E,AA,AS,DL,UA,VX 1863   920 0 (0.50617284 0.49382716)  
##         24) dep_delay&lt; 44.5 1309   590 0 (0.54927426 0.45072574) *
##         25) dep_delay&gt;=44.5 554   224 1 (0.40433213 0.59566787)  
##           50) lat&gt;=44.26406 29    12 0 (0.58620690 0.41379310) *
##           51) lat&lt; 44.26406 525   207 1 (0.39428571 0.60571429) *
##       13) carrier=B6,EV,F9,FL,HA,MQ,US,WN,YV 2498   790 1 (0.31625300 0.68374700) *
##      7) dep_delay&gt;=48.5 15055   561 1 (0.03726337 0.96273663) *</code></pre>
<pre class="r"><code>library(rpart.plot)

pull_final_tree= final_tree %&gt;%
  pull_workflow_fit()

rpart.plot(pull_final_tree$fit,roundint=FALSE)</code></pre>
<p><img src="NYC_Flights_TidyModel_files/figure-html/unnamed-chunk-29-1.png" width="672" /></p>
<pre class="r"><code>library(vip)

pull_final_tree %&gt;%
  vip()+
   theme_bw()</code></pre>
<p><img src="NYC_Flights_TidyModel_files/figure-html/unnamed-chunk-30-1.png" width="672" /></p>
</div>
</div>
<div id="test-fit" class="section level1">
<h1><span class="header-section-number">5</span> Test Fit</h1>
<div id="tree-fit" class="section level2">
<h2><span class="header-section-number">5.1</span> Tree Fit</h2>
<pre class="r"><code>flights_pred &lt;-
  predict(final_tree,flights_test,type=&quot;prob&quot;) %&gt;%
  bind_cols(  flights_test %&gt;% select(is_late)  )

flights_pred %&gt;%
  roc_curve(truth=is_late, .pred_0)%&gt;%
  autoplot()</code></pre>
<p><img src="NYC_Flights_TidyModel_files/figure-html/unnamed-chunk-31-1.png" width="672" /></p>
<pre class="r"><code>flights_pred %&gt;% 
  roc_auc(truth = is_late, .pred_0) %&gt;%
  bind_rows(

predict(final_tree,flights_test) %&gt;%
  bind_cols( bind_cols(  flights_test %&gt;% select(is_late)  ))%&gt;% 
  accuracy(truth=is_late,.pred_class)
)</code></pre>
<pre><code>## # A tibble: 2 x 3
##   .metric  .estimator .estimate
##   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
## 1 roc_auc  binary         0.922
## 2 accuracy binary         0.951</code></pre>
<pre class="r"><code>predict(final_tree,flights_test) %&gt;%
  bind_cols( bind_cols(  flights_test %&gt;% select(is_late)  ))%&gt;%
conf_mat(truth=is_late,estimate=.pred_class)</code></pre>
<pre><code>##           Truth
## Prediction     0     1
##          0 58987  2613
##          1   772  7351</code></pre>
</div>
<div id="logistic-fit" class="section level2">
<h2><span class="header-section-number">5.2</span> Logistic Fit</h2>
<pre class="r"><code>logist_pred &lt;-
  predict(logt_fit,new_data = flights_test ,type = &quot;prob&quot;) %&gt;%
  bind_cols(  flights_test %&gt;% select(is_late)  )</code></pre>
<pre><code>## Warning in predict.lm(object, newdata, se.fit, scale = 1, type = if (type == :
## prediction from a rank-deficient fit may be misleading</code></pre>
<pre class="r"><code>logist_pred %&gt;%
  roc_curve(truth=is_late, .pred_0)%&gt;%
  autoplot()</code></pre>
<p><img src="NYC_Flights_TidyModel_files/figure-html/unnamed-chunk-34-1.png" width="672" /></p>
<pre class="r"><code>logist_pred %&gt;% 
  roc_auc(truth = is_late, .pred_0) %&gt;%
  bind_rows(
    
  predict(logt_fit,flights_test) %&gt;%
  bind_cols( bind_cols(  flights_test %&gt;% select(is_late)  ))%&gt;% 
  accuracy(truth=is_late,.pred_class)  
    
    
  )</code></pre>
<pre><code>## Warning in predict.lm(object, newdata, se.fit, scale = 1, type = if (type == :
## prediction from a rank-deficient fit may be misleading</code></pre>
<pre><code>## # A tibble: 2 x 3
##   .metric  .estimator .estimate
##   &lt;chr&gt;    &lt;chr&gt;          &lt;dbl&gt;
## 1 roc_auc  binary         0.956
## 2 accuracy binary         0.952</code></pre>
<pre class="r"><code>predict(logt_fit,flights_test) %&gt;%
  bind_cols( bind_cols(  flights_test %&gt;% select(is_late)  ))%&gt;%
conf_mat(truth=is_late,estimate=.pred_class)</code></pre>
<pre><code>## Warning in predict.lm(object, newdata, se.fit, scale = 1, type = if (type == :
## prediction from a rank-deficient fit may be misleading</code></pre>
<pre><code>##           Truth
## Prediction     0     1
##          0 58838  2454
##          1   921  7510</code></pre>
<p>Always predicting a plane not being late, would lead to a an accuracy of 86%.</p>
<pre class="r"><code>(58838+921)/69732*100</code></pre>
<pre><code>## [1] 85.6981</code></pre>
</div>
<div id="both-fits-compared" class="section level2">
<h2><span class="header-section-number">5.3</span> Both Fits Compared</h2>
<pre class="r"><code>predict(final_tree, flights_test, type = &quot;prob&quot;) %&gt;%
  bind_cols(flights_test %&gt;% select(is_late)) %&gt;%
  roc_curve(truth = is_late, .pred_0) %&gt;%
  mutate(model = &quot;Decision Tree&quot;) %&gt;%
  bind_rows(
    predict(logt_fit, flights_test, type = &quot;prob&quot;) %&gt;%
      bind_cols(flights_test %&gt;% select(is_late)) %&gt;%
      roc_curve(truth = is_late, .pred_0) %&gt;%
      mutate(model = &quot;Logistic&quot;)
  ) %&gt;%
  ggplot(aes(x = 1 - sensitivity,y = specificity,col = model)) +
  geom_path(size = 1.5) +
  geom_abline(slope = 1,lty = 2,col = &quot;grey60&quot;,size = 2) +
  coord_equal()+
   theme_bw()</code></pre>
<pre><code>## Warning in predict.lm(object, newdata, se.fit, scale = 1, type = if (type == :
## prediction from a rank-deficient fit may be misleading</code></pre>
<p><img src="NYC_Flights_TidyModel_files/figure-html/unnamed-chunk-38-1.png" width="672" /></p>
<pre class="r"><code>flights_pred %&gt;% 
  roc_auc(truth = is_late, .pred_0) %&gt;%
  bind_rows(

predict(final_tree,flights_test) %&gt;%
  bind_cols( bind_cols(  flights_test %&gt;% select(is_late)  ))%&gt;% 
  accuracy(truth=is_late,.pred_class)
) %&gt;% bind_cols(Model =&quot;Decision Tree&quot;) %&gt;%
  bind_rows(
    logist_pred %&gt;% 
  roc_auc(truth = is_late, .pred_0) %&gt;%
  bind_rows(
    
  predict(logt_fit,flights_test) %&gt;%
  bind_cols( bind_cols(  flights_test %&gt;% select(is_late)  ))%&gt;% 
  accuracy(truth=is_late,.pred_class)  
    
    
  ) %&gt;% bind_cols(Model=&quot;Logistic&quot;)
  ) %&gt;%
  pivot_wider(names_from = .metric, values_from=.estimate) %&gt;%
  select(-.estimator)</code></pre>
<pre><code>## Warning in predict.lm(object, newdata, se.fit, scale = 1, type = if (type == :
## prediction from a rank-deficient fit may be misleading</code></pre>
<pre><code>## # A tibble: 2 x 3
##   Model         roc_auc accuracy
##   &lt;chr&gt;           &lt;dbl&gt;    &lt;dbl&gt;
## 1 Decision Tree   0.922    0.951
## 2 Logistic        0.956    0.952</code></pre>
</div>
</div>
<div id="post-hoc-analysis" class="section level1">
<h1><span class="header-section-number">6</span> Post-Hoc Analysis</h1>
<p>We can see what type of predictions the models made by generating fake data</p>
<pre class="r"><code>#Fake Date of the Top 3 Most Visited Locations On a Specific Day With Normal Weather Conditions

fake_data = crossing(
  dep_delay=seq(0,75),
  carrier=c(&quot;UA&quot;,&quot;B6&quot;,&quot;EV&quot;,&quot;DL&quot;,&quot;US&quot;,&quot;9E&quot;),
  origin=c(&quot;EWR&quot;,&quot;JFK&quot;,&quot;LGA&quot;),
  temp=65,
  precip = 0,
  visib = 0,
  mnfr_year = (&quot;2000&quot;),
  seats = 200,
  engine_type = c(&quot;Turbo-fan&quot;, &quot;Turbo-jet&quot;, &quot;Other&quot;),
  lat = c(33.94254,33.63672,42.36435), 
  lon = c(-118.40807,-84.42807,-71.00518),
  alt = c(126,1026,19),
  tzone=c(&quot;America/Los_Angeles&quot;,&quot;America/New_York&quot;,&quot;America/New_York&quot;),
  dep_date=date(&quot;2013-09-16&quot;)
)
fake_data %&gt;%
  mutate(mnfr_year = factor(mnfr_year),
         engine_type = factor(engine_type),
         tzone= factor(tzone),
         carrier=factor(carrier))</code></pre>
<pre><code>## # A tibble: 221,616 x 14
##    dep_delay carrier origin  temp precip visib mnfr_year seats engine_type   lat
##        &lt;int&gt; &lt;fct&gt;   &lt;chr&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt;     &lt;dbl&gt; &lt;fct&gt;       &lt;dbl&gt;
##  1         0 9E      EWR       65      0     0 2000        200 Other        33.6
##  2         0 9E      EWR       65      0     0 2000        200 Other        33.6
##  3         0 9E      EWR       65      0     0 2000        200 Other        33.6
##  4         0 9E      EWR       65      0     0 2000        200 Other        33.6
##  5         0 9E      EWR       65      0     0 2000        200 Other        33.6
##  6         0 9E      EWR       65      0     0 2000        200 Other        33.6
##  7         0 9E      EWR       65      0     0 2000        200 Other        33.6
##  8         0 9E      EWR       65      0     0 2000        200 Other        33.6
##  9         0 9E      EWR       65      0     0 2000        200 Other        33.6
## 10         0 9E      EWR       65      0     0 2000        200 Other        33.6
## # ... with 221,606 more rows, and 4 more variables: lon &lt;dbl&gt;, alt &lt;dbl&gt;,
## #   tzone &lt;fct&gt;, dep_date &lt;date&gt;</code></pre>
<p>`</p>
<pre class="r"><code>fake_prediction = predict(logt_fit,new_data = fake_data,type=&quot;prob&quot;)</code></pre>
<pre><code>## Warning in predict.lm(object, newdata, se.fit, scale = 1, type = if (type == :
## prediction from a rank-deficient fit may be misleading</code></pre>
<pre class="r"><code>fake_prediction  %&gt;%
  bind_cols(  fake_data ) %&gt;%
  filter(lat ==33.63672  &amp;  lon==-118.40807 &amp; alt==126 &amp; tzone ==&quot;America/Los_Angeles&quot;) %&gt;%
  #filter(carrier %in% c(&quot;US&quot;,&quot;UA&quot;)) %&gt;%
  ggplot(aes(x=dep_delay,y=.pred_1,col=carrier))+
  #geom_line(size=1.5)+
  geom_path()+
  facet_grid(origin~engine_type)+
  labs(title=&quot;Logistic Model Probabilities of Flight being Late&quot;,subtitle=&quot;Variation Between Engine Type, Carrier and Origin&quot;)+
   theme_bw()</code></pre>
<p><img src="NYC_Flights_TidyModel_files/figure-html/unnamed-chunk-42-1.png" width="672" /></p>
<pre class="r"><code>fake_prediction = predict(final_tree,new_data=fake_data,type=&quot;prob&quot;)</code></pre>
<pre class="r"><code>fake_prediction  %&gt;%
  bind_cols(  fake_data ) %&gt;%
  filter(lat ==33.63672  &amp;  lon==-118.40807 &amp; alt==126 &amp; tzone ==&quot;America/Los_Angeles&quot;) %&gt;%
 #filter(carrier %in% c(&quot;US&quot;,&quot;UA&quot;)) %&gt;%
  ggplot(aes(x=dep_delay,y=.pred_1,col=carrier))+
  geom_line(size=1)+
  facet_grid(origin~engine_type)+
  labs(title=&quot;Decision Tree Probabilities of Flight being Late&quot;,subtitle=&quot;Variation Between Engine Type, Carrier and Origin&quot;)+
   theme_bw()</code></pre>
<p><img src="NYC_Flights_TidyModel_files/figure-html/unnamed-chunk-44-1.png" width="672" /></p>
<p>We observe that the departure delay is extremely important in both models, and we also see how different carriers have different probabilities of being late. We also notice that there is very little differences between the origin of flight and the engine type of the aircraft.</p>
<p>We could further see how abnormal weather events may impact the arrival time, we could even try to see how the the day-by-day probabilities are affected if we fix everything else.</p>
<p>We could also investigate where the models went wrong, and true to see what the causes maybe and use the information for better models in the future.</p>
<div id="concluson" class="section level2">
<h2><span class="header-section-number">6.1</span> Concluson</h2>
<p>Overall, it seems that the most important feature in trying to determine whether a flight will arrive 30 minutes late is the amount of time the plane was delayed on departure. We have also observed some interesting effects due to day,month and weather events.</p>
<p>Some information was removed earlier, such as the time of day of flight. We have see that the time of day is important in discovering if a flight was late or not. For some reason this was removed.</p>
<p>Another way to improve the model would be to use factor lump on carriers that appear very few number of times. This could helping in making the model simplifier.</p>
<p>In contrast, we could make the model more complex; we could add non-linear transformations, like splines, on continuous variables such as: <code>lon</code>, <code>lat</code>, <code>precip</code>, or <code>temp</code>. This should improve the model predictability.</p>
<p>In reality it may be difficult to know by how delayed a flight will be delayed on departure, so another method could be to remove the departure delay feature. This may not improve final predictability, but it could more accurately represent real world conditions and be more useful for slightly long term predictions, on the order of around several days.</p>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
